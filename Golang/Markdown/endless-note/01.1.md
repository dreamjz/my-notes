---
title: Graceful Shutdown or Restart
date: '2021-11-23'
categories:
 - golang
 - docker
tags:
 - endless
 - gin
---

# Graceful Shutdown or Restart

在学习 gin 时，官方文档介绍如何优雅地启动和停止服务

这里以 [endless](https://github.com/fvbock/endless) 为例，开始学习

## Introduction

Zero downtime restarts for golang HTTP and HTTPS servers.

### Features

- Drop-in replacement for `http.ListenAndServe` and `http.ListenAndServeTLS`
- Signal hooks to execute your own code before or after the listened to signal (SIGHUP, SIGUSR1, SIGUER2, SIGINT, SIGTERM, SIGSTP)
- You can start multiple servers from one binary and endless will take care of the different sockets/ports assignments when restarting

## Quick Start

```sh
go get -u github.com/fvbock/endless
```

```go
package main

import (
	"github.com/fvbock/endless"
	"github.com/gin-gonic/gin"
	"log"
	"net/http"
)

func main(){
	router := gin.Default()
	router.GET("ping", func(c *gin.Context) {
		c.String(http.StatusOK,"pong")
	})
	err := endless.ListenAndServe(":9090",router)
	if err != nil {
		log.Fatal("listen and serve error:",err.Error())
	}
	log.Println("Server on 9090 stopped")
}
```

编译并启动程序：

```sh
$ go build -o ./main ./main.go
$ ./main
# ... some gin logs
[GIN-debug] GET    /ping                     --> main.main.func1 (3 handlers)
2021/11/23 20:04:53 31409 :9090
```

简单测试下：

 ```sh
 $ curl "http://localhost:9090/ping"
 pong
 ```

发送 `SIGHUP` 信号

```sh
$ kill -1 31409
---------
# ... some logs
2021/11/23 20:13:35 32215 :9090
2021/11/23 20:13:35 31409 Received SIGTERM.
2021/11/23 20:13:35 31409 Waiting for connections to finish...
2021/11/23 20:13:35 31409 Serve() returning...
2021/11/23 20:13:35 listen and serve error:accept tcp [::]:9090: use of closed network connection
```

​	再次发送请求，可以看到程序依然能够接收请求

```sh
```

